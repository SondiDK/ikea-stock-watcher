name: IKEA Stock Checker

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allows manual trigger

jobs:
  check-stock:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install ikea-availability-checker

    - name: Check IKEA stock
      run: |
        echo "=== Checking IKEA stock ==="
        # Attempt multiple times in case of timeout
        for attempt in 1 2 3; do
          echo "Attempt $attempt..."
          npx ikea-availability-checker 30572984 --country dk > stock.txt && break
          echo "‚è≥ Waiting 5s before retry..."
          sleep 5
        done

        echo "=== Stock Result ==="
        cat stock.txt
        echo "=== Finished stock check ==="

    # Optional: Send result via email
    #- name: Send email with stock results
    #  uses: dawidd6/action-send-mail@v3
    #  with:
    #    server_address: ${{ secrets.SMTP_SERVER }}
    #    server_port: ${{ secrets.SMTP_PORT }}
    #    username: ${{ secrets.SMTP_USER }}
    #    password: ${{ secrets.SMTP_PASSWORD }}
    #    subject: "IKEA Stock Check Result"
    #    body: |
    #      Stock check done. See below:
    #      $(cat stock.txt)
    #    to: ${{ secrets.EMAIL_TO }}
    #    from: ${{ secrets.EMAIL_FROM }}
