name: IKEA Stock Checker

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  workflow_dispatch: # manual trigger

jobs:
  check-stock:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3️⃣ Install dependencies (if any)
      - name: Install dependencies
        run: npm install

      # 4️⃣ Fetch IKEA stock as JSON
      - name: Fetch IKEA stock
        id: fetch
        run: |
          echo "=== Fetching IKEA stock (JSON) ==="
          JSON=$(npx ikea-availability-checker --json 30572984 --country dk || true)
          echo "$JSON"
          echo "json<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5️⃣ Parse JSON and check for stock
      - name: Parse stock
        id: parse
        run: |
          node <<'EOF'
          const fs = require("fs");
          const raw = process.env.JSON;
          const outputFile = process.env.GITHUB_OUTPUT;

          let data;
          try {
            data = JSON.parse(raw);
          } catch (err) {
            console.log("❌ Failed to parse JSON");
            console.log(err);
            process.exit(0);
          }

          const wantedStores = ["094","121","686"]; // Taastrup, Gentofte, København
          const relevant = data.filter(item => wantedStores.includes(item.buCode));
          const stocked = relevant.filter(item => item.stock > 0);

          console.log("Relevant stores:", relevant);
          console.log("Stores with stock:", stocked);

          // Set workflow outputs
          fs.appendFileSync(outputFile, `found_stock=${stocked.length > 0}\n`);
          fs.appendFileSync(outputFile, `details<<EOF\n${JSON.stringify(stocked, null, 2)}\nEOF\n`);
          EOF
        env:
          JSON: ${{ steps.fetch.outputs.json }}

      # 6️⃣ Send email if stock exists
      - name: Send notification email
        if: steps.parse.outputs.found_stock == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}
          from: "IKEA Stock Bot <${{ secrets.MAIL_USER }}>"
          to: "oling94@gmail.com, celinvavkuhn@gmail.com" # multiple recipients
          subject: "IKEA product 30572984 is IN STOCK!"
          body: |
            The product is IN STOCK in at least one of the monitored stores:

            ${{ steps.parse.outputs.details }}
