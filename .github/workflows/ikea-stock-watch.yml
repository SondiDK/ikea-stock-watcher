name: IKEA Stock Checker (CLI)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

jobs:
  check-stock:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install CLI
        run: npm install ikea-availability-checker

      - name: Run stock check via CLI
        id: check_stock
        run: |
          echo "=== Checking IKEA stock ==="

          # Run CLI and capture output to a variable
          OUTPUT=$(npx ikea-availability-checker 30572984 --country dk)

          echo "=== RAW CLI OUTPUT (visible in logs) ==="
          echo "$OUTPUT"

          # Expose for next steps
          # Must escape % for GitHub Actions
          OUTPUT_ESCAPED="${OUTPUT//'%'/'%25'}"
          OUTPUT_ESCAPED="${OUTPUT_ESCAPED//$'\n'/'%0A'}"
          OUTPUT_ESCAPED="${OUTPUT_ESCAPED//$'\r'/'%0D'}"

          echo "::set-output name=result::$OUTPUT_ESCAPED"

          echo "=== Finished CLI run ==="

      - name: Debug RAW output (full JSON.stringify)
        run: |
          node << 'EOF'
          const raw = process.env.RAW;
          console.log("=== RAW DEBUG START ===");
          console.log(JSON.stringify(raw, null, 2));
          console.log("=== RAW DEBUG END ===");
          EOF
        env:
          RAW: ${{ steps.check_stock.outputs.result }}
